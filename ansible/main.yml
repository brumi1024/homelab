---
- hosts: nas
  roles:
    - name: Export NFS shares on NFS server
      role: nfs
    - role: autorestic

- hosts: server, !dev
  become: true
  roles:
    - name: Create root, intermediate CA for Vault
      role: kencx.ansible.ssl
      become: true
      run_once: true

    - role: vault
    - role: consul-template
    - role: consul
    - role: nomad

  tasks:
    - name: Goss smoke test
      import_role:
        name: kencx.ansible.goss
      vars:
        goss_dir: "./goss"
        goss_file: "server.yml"

- hosts: client, !dev
  become: true
  roles:
    - name: Mount NFS shares on client
      role: kencx.ansible.nfs

    - role: vault
    - role: consul-template
    - role: consul
    - role: nomad

  tasks:
    - name: Goss smoke test
      import_role:
        name: kencx.ansible.goss
      vars:
        goss_dir: "./goss"
        goss_file: "client.yml"
