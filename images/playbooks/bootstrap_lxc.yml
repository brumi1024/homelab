---
- hosts: lxc
  pre_tasks:
    - name: Update and upgrade packages
      become: true
      apt:
        upgrade: true
        update_cache: true
        cache_valid_time: 86400
      # debian 10
      # command:
      #   cmd: "apt update --allow-releaseinfo-change"

    - name: Install packages
      become: true
      package:
        name: "{{ item }}"
        state: present
      with_items: "{{ apps | default([sudo]) }}"

    - name: Create user
      become: true
      user:
        name: "{{ template_user }}"
        uid: "{{ template_uid | default(1000) }}"
        create_home: true
        groups: sudo
        shell: /bin/bash
        # set temp password that must be changed on first login
        password: "{{ template_password | password_hash('sha512') }}"
        update_password: on_create
      register: new_user

    # https://github.com/ansible/ansible/issues/18917#issuecomment-520254763
    - name: Force reset password on first login
      become: true
      command: "chage -d 0 {{ template_user }}"
      when: new_user.changed

    - name: Add new SSH authorized key to user
      authorized_key:
        user: "{{ template_user }}"
        key: "{{ lookup('file', ssh_key_file) }}"
        state: present

    - name: Create new SSH key for user
      user:
        name: "{{ template_user }}"
        generate_ssh_key: true
        ssh_key_type: "ed25519"
        ssh_key_file: ".ssh/id_ed25519"

  roles:
    - role: kencx.ansible.security
      vars:
        ssh_disable_root_login: true
        skip_handlers: true

    - role: geerlingguy.docker
      vars:
        docker_compose_version: "v2.2.2"
        docker_compose_arch: x86_64
        docker_users: ["{{ template_user }}"]

  post_tasks:
    - name: Clean up
      apt:
        autoremove: true
        autoclean: true

    - name: Delete temporary files
      become: true
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "/var/tmp"
        - "/tmp"
