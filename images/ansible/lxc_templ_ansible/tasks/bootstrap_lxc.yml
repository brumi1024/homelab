---
- hosts: all
  tasks:

    - name: update and upgrade packages
      command: "pct exec {{ template_id }} -- {{ item }}"
      changed_when: true
      with_items:
        - "apt update --allow-releaseinfo-change"
        - "apt upgrade -y"

    - name: install packages
      command: "pct exec {{ template_id }} -- {{ item }}"
      changed_when: true
      with_items:
        - "apt install -y curl sudo vim openssh-server"

    - name: Create user
      command: "pct exec {{ template_id }} -- {{ item }}"
      changed_when: true
      with_items:
        - "useradd -m {{ template_user }}"
        - "usermod -aG sudo {{ template_user }}"
        # remember to set passwd

    - name: Configure sudo
      command: "pct exec {{ template_id }} -- {{ item }}"
      changed_when: true
      with_items:
        - "bash -c 'echo \"{{ template_user }} ALL=(ALL:ALL) ALL\" >> /etc/sudoers.d/{{ template_user }}'"

    # - name: Install docker
    #   command: "pct exec {{ template_id }} -- {{ item }}"
    #   changed_when: true
    #   with_items:
    #     -
    #
    # - name: Configure docker
    #   command: "pct exec {{ template_id }} -- {{ item }}"
    #   changed_when: true
    #   with_items:
    #     -
    #
    # - name: Install docker-compose
    #   command: "pct exec {{ template_id }} -- {{ item }}"
    #   changed_when: true
    #   with_items:
    #     -

    - name: Start and enable sshd
      command: "pct exec {{ template_id }} -- {{ item }}"
      changed_when: true
      with_items:
        - "systemctl start sshd"
        - "systemctl enable ssh"

    - name: Clean up
      command: "pct exec {{ template_id }} -- {{ item }}"
      changed_when: true
      with_items:
        - "apt autoremove"
        - "rm -rf /tmp/*"
        - "rm -rf /var/cache/apt"
