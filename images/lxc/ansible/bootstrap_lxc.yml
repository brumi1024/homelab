---
- hosts: lxc
  pre_tasks:
    # fails on debian 10 as --allow-release-info-change is needed
    - name: update and upgrade packages
      become: true
      apt:
        upgrade: true
        update_cache: true
        cache_valid_time: 86400
      # command:
      #   cmd: "apt update --allow-releaseinfo-change"

    - name: install packages
      package:
        name: "{{ item }}"
        state: present
      with_items: "{{ apps | default([sudo]) }}"

    - name: Create user
      user:
        name: "{{ template_user }}"
        uid: "{{ template_uid | default(1000) }}"
        groups: sudo

  roles:
    - role: kencx.homelab.security
    - role: geerlingguy.docker
      vars:
        docker_compose_version: "v2.2.2"
        docker_compose_arch: x86_64
        docker_users: ["{{ template_user }}"]

  post_tasks:
    - name: Clean up
      apt:
        autoremove: true
        autoclean: true
