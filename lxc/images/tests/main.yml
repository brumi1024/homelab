---
- hosts: pve
  vars_files:
    - test_vars.yml
  tasks:
    - name: Generate random password
      set_fact:
        random_password: "{{ lookup('password', '/dev/null') }}"

    - name: Generate SSH key pair
      community.crypto.openssh_keypair:
        path: "/tmp/temp_ssh_key"
        regenerate: always
        type: "ed25519"
        state: present
      register: temp_ssh_key
      delegate_to: localhost

    - name: Create temp LXC
      proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"
        storage: "{{ proxmox_storage }}"

        node: "{{ proxmox_node }}"
        vmid: "{{ test_vmid }}"
        hostname: "{{ test_hostname }}"
        ostemplate: "local:vztmpl/{{ test_template_name }}"
        unprivileged: true

        cores: 1
        memory: 1024
        swap: 1024
        disk: "{{ test_disk_size }}"

        netif: '{"net0":"name=eth0,ip={{ test_ip_address }},gw={{ test_gateway }},bridge=vmbr1"}'
        password: "{{ random_password }}"
        pubkey: "{{ temp_ssh_key.public_key }}"
        state: present

    - name: Start temp LXC
      proxmox:
        node: "{{ proxmox_node }}"
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_api_token_id }}"
        api_token_secret: "{{ proxmox_api_token_secret }}"

        vmid: "{{ test_vmid }}"
        state: started

# - import_playbook: tests.yml
#
# - hosts: pve
#   vars_files:
#     - test_vars.yml
#   tasks:
#   - name: Remove temp LXC
#     proxmox:
#       node: "{{ proxmox_node }}"
#       api_host: "{{ proxmox_api_host }}"
#       api_user: "{{ proxmox_api_user }}"
#       api_token_id: "{{ proxmox_api_token_id }}"
#       api_token_secret: "{{ proxmox_api_token_secret }}"
#
#       vmid: "{{ test_vmid }}"
#       state: absent
